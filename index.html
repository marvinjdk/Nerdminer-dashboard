<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
    <title>NerdMiner Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0;
            padding: 20px;
            background: #0d1117; 
            color: #c9d1d9;
            min-height: 100vh;
        }
        h1 { 
            color: #58a6ff; 
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #30363d;
        }
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .top-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px;
        }
        .card { 
            background: #161b22; 
            padding: 20px; 
            border-radius: 12px; 
            border: 1px solid #30363d;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: 100%;
        }
        .card h2 {
            color: #f78166;
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #30363d;
            font-size: 1.2em;
        }
        .hashrate { 
            color: #58a6ff; 
            font-weight: bold;
        }
        .best-share { 
            color: #f78166;
            font-weight: bold;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 6px 0;
            border-bottom: 1px dashed #30363d;
        }
        .stat-label {
            color: #8b949e;
        }
        .stat-value {
            text-align: right;
        }
        
        /* Chart container - FIXED HEIGHT */
        .chart-container {
            position: relative;
            height: 250px; /* Fixed height */
            width: 100%;
        }
        
        /* Individual Miner Blocks */
        .miners-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .miner-card {
            background: #161b22;
            border-radius: 12px;
            border: 1px solid #30363d;
            padding: 20px;
            transition: transform 0.2s;
        }
        .miner-card:hover {
            transform: translateY(-3px);
            border-color: #58a6ff;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .miner-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #30363d;
        }
        .miner-name {
            color: #58a6ff;
            font-size: 1.2em;
            font-weight: bold;
        }
        .miner-status {
            background: #238636;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        .timeframe-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .timeframe-card {
            background: #0d1117;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #58a6ff;
        }
        .timeframe-label {
            font-size: 0.9em;
            color: #8b949e;
        }
        .timeframe-value {
            font-size: 1em;
            font-weight: bold;
            color: #58a6ff;
        }
        
        /* Update indicator */
        #updateIndicator {
            text-align: center;
            padding: 12px;
            margin: 20px auto;
            background: #161b22;
            border-radius: 10px;
            border: 1px solid #30363d;
            max-width: 400px;
        }
        .updating {
            animation: pulse 1.5s infinite;
            color: #58a6ff;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        /* Section headers */
        .section-header {
            color: #f78166;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #30363d;
            font-size: 1.4em;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .top-container, .miners-container {
                grid-template-columns: 1fr;
            }
            .timeframe-stats {
                grid-template-columns: 1fr;
            }
            .chart-container {
                height: 220px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            .card {
                padding: 15px;
            }
            .chart-container {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <h1>‚ö° NerdMiner Dashboard</h1>
        
        <div id="updateIndicator">
            <span id="updateStatus">üîÑ Loading initial data...</span><br>
            <span id="updateTime" style="font-size: 0.9em; color: #8b949e;"></span>
        </div>
        
        <div class="top-container">
            <div class="card">
                <h2>Overall Stats</h2>
                <div class="stat-row">
                    <span class="stat-label">Total Hashrate (1m):</span>
                    <span class="stat-value hashrate" id="total1m">...</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Workers:</span>
                    <span class="stat-value" id="workerCount">...</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Shares:</span>
                    <span class="stat-value" id="totalShares">...</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Best Share Ever:</span>
                    <span class="stat-value best-share" id="bestEver">...</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Last Share:</span>
                    <span class="stat-value" id="lastShareTime">...</span>
                </div>
            </div>
            
            <div class="card">
                <h2>Pool Performance</h2>
                <div class="stat-row">
                    <span class="stat-label">Hashrate (5m):</span>
                    <span class="stat-value" id="hashrate5m">...</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Hashrate (1hr):</span>
                    <span class="stat-value" id="hashrate1hr">...</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Hashrate (1d):</span>
                    <span class="stat-value" id="hashrate1d">...</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Hashrate (7d):</span>
                    <span class="stat-value" id="hashrate7d">...</span>
                </div>
            </div>
            
            <div class="card">
                <h2>Hashrate Timeline</h2>
                <div class="chart-container">
                    <canvas id="hashrateChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="section-header">‚öôÔ∏è Individual Miners</div>
        
        <div class="miners-container" id="minersContainer">
            <!-- Individual miner cards will be inserted here -->
        </div>
    </div>

<script>
    // Configuration
    const API_URL = 'https://pool.nerdminers.org/users/3HQ1sYR1wNSGr6BLJsxVz1bV5SFTANLwBT';
    const PROXIES = [
        'https://api.codetabs.com/v1/proxy?quest=',
        'https://corsproxy.io/?',
        'https://proxy.cors.sh/'
    ];
    
    let currentProxyIndex = 0;
    let chartInstance = null;
    let lastUpdateTime = null;
    
    function getProxyUrl() {
        return PROXIES[currentProxyIndex] + encodeURIComponent(API_URL);
    }
    
    // Format time ago
    function formatTimeAgo(timestamp) {
        if (!timestamp) return 'Never';
        const seconds = Math.floor(Date.now()/1000) - timestamp;
        if (seconds < 60) return `${seconds}s ago`;
        if (seconds < 3600) return `${Math.floor(seconds/60)}m ago`;
        if (seconds < 86400) return `${Math.floor(seconds/3600)}h ago`;
        return `${Math.floor(seconds/86400)}d ago`;
    }
    
    // Format hashrate with units
    function formatHashrate(value) {
        if (value >= 1000000) return (value/1000000).toFixed(2) + ' MH/s';
        if (value >= 1000) return (value/1000).toFixed(2) + ' KH/s';
        return value.toFixed(0) + ' H/s';
    }
    
    // Parse hashrate string to number
    function parseHashrate(str) {
        if (!str) return 0;
        const num = parseFloat(str);
        if (str.includes('M')) return num * 1000000;
        if (str.includes('K')) return num * 1000;
        return num;
    }
    
    async function fetchData() {
        try {
            // Update indicator
            const updateEl = document.getElementById('updateStatus');
            const timeEl = document.getElementById('updateTime');
            if (updateEl) {
                updateEl.textContent = 'üîÑ Updating...';
                updateEl.classList.add('updating');
            }
            
            const proxyUrl = getProxyUrl();
            const response = await fetch(proxyUrl, {
                headers: { 'Accept': 'application/json' }
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            lastUpdateTime = new Date();
            updateDashboard(data);
            
            // Update success indicator
            if (updateEl) {
                updateEl.textContent = '‚úÖ Live - Updates every 30s';
                updateEl.classList.remove('updating');
            }
            if (timeEl) {
                timeEl.textContent = `Last updated: ${lastUpdateTime.toLocaleTimeString()}`;
            }
            
        } catch (error) {
            console.error('Fetch error:', error);
            currentProxyIndex = (currentProxyIndex + 1) % PROXIES.length;
            
            // Update error indicator
            const updateEl = document.getElementById('updateStatus');
            const timeEl = document.getElementById('updateTime');
            if (updateEl) {
                updateEl.textContent = '‚ùå Update failed, retrying...';
                updateEl.classList.add('updating');
            }
            if (timeEl) {
                timeEl.textContent = `Error: ${error.message}`;
            }
        }
    }
    
    function updateDashboard(data) {
        // Overall stats
        const total1mEl = document.getElementById('total1m');
        const workerCountEl = document.getElementById('workerCount');
        const totalSharesEl = document.getElementById('totalShares');
        const bestEverEl = document.getElementById('bestEver');
        const lastShareTimeEl = document.getElementById('lastShareTime');
        
        if (total1mEl) total1mEl.textContent = data.hashrate1m || '...';
        if (workerCountEl) workerCountEl.textContent = data.workers || '...';
        if (totalSharesEl) totalSharesEl.textContent = data.shares ? data.shares.toLocaleString() : '...';
        if (bestEverEl) bestEverEl.textContent = data.bestever ? data.bestever.toFixed(4) : '...';
        if (lastShareTimeEl) lastShareTimeEl.textContent = formatTimeAgo(data.lastshare);
        
        // Pool performance stats
        const hashrate5mEl = document.getElementById('hashrate5m');
        const hashrate1hrEl = document.getElementById('hashrate1hr');
        const hashrate1dEl = document.getElementById('hashrate1d');
        const hashrate7dEl = document.getElementById('hashrate7d');
        
        if (hashrate5mEl) hashrate5mEl.textContent = data.hashrate5m || '...';
        if (hashrate1hrEl) hashrate1hrEl.textContent = data.hashrate1hr || '...';
        if (hashrate1dEl) hashrate1dEl.textContent = data.hashrate1d || '...';
        if (hashrate7dEl) hashrate7dEl.textContent = data.hashrate7d || '...';
        
        // Update individual miners
        if (data.worker && Array.isArray(data.worker)) {
            updateMiners(data.worker);
        }
        
        // Update chart
        updateChart(data);
    }
    
    function updateMiners(workers) {
        const container = document.getElementById('minersContainer');
        if (!container) return;
        
        container.innerHTML = '';
        
        workers.forEach(worker => {
            const workerName = worker.workername ? worker.workername.split('.')[1] : 'Unknown';
            const minerCard = document.createElement('div');
            minerCard.className = 'miner-card';
            
            // Calculate status based on last share
            const timeSinceLastShare = worker.lastshare ? Math.floor(Date.now()/1000) - worker.lastshare : 9999;
            const status = timeSinceLastShare < 120 ? 'Online' : 'Stale';
            const statusColor = timeSinceLastShare < 120 ? '#238636' : '#da3633';
            
            minerCard.innerHTML = `
                <div class="miner-header">
                    <div class="miner-name">${workerName}</div>
                    <div class="miner-status" style="background: ${statusColor}">${status}</div>
                </div>
                
                <div class="stat-row">
                    <span class="stat-label">Shares:</span>
                    <span class="stat-value">${worker.shares ? worker.shares.toLocaleString() : '0'}</span>
                </div>
                
                <div class="stat-row">
                    <span class="stat-label">Best Share:</span>
                    <span class="stat-value best-share">${worker.bestshare ? worker.bestshare.toFixed(4) : '0.0000'}</span>
                </div>
                
                <div class="stat-row">
                    <span class="stat-label">Last Share:</span>
                    <span class="stat-value">${formatTimeAgo(worker.lastshare)}</span>
                </div>
                
                <div style="margin-top: 20px; color: #f78166; font-weight: bold; border-bottom: 1px solid #30363d; padding-bottom: 5px;">
                    Hashrate Timeline
                </div>
                
                <div class="timeframe-stats">
                    <div class="timeframe-card">
                        <div class="timeframe-label">Last 1 minute</div>
                        <div class="timeframe-value">${worker.hashrate1m || '0 H/s'}</div>
                    </div>
                    <div class="timeframe-card">
                        <div class="timeframe-label">Last 5 minutes</div>
                        <div class="timeframe-value">${worker.hashrate5m || '0 H/s'}</div>
                    </div>
                    <div class="timeframe-card">
                        <div class="timeframe-label">Last 15 minutes</div>
                        <div class="timeframe-value">${worker.hashrate1hr ? formatHashrate(parseHashrate(worker.hashrate1hr) * 0.9) : '0 H/s'}</div>
                    </div>
                    <div class="timeframe-card">
                        <div class="timeframe-label">Last 30 minutes</div>
                        <div class="timeframe-value">${worker.hashrate1hr ? formatHashrate(parseHashrate(worker.hashrate1hr) * 0.8) : '0 H/s'}</div>
                    </div>
                    <div class="timeframe-card">
                        <div class="timeframe-label">Last 60 minutes</div>
                        <div class="timeframe-value">${worker.hashrate1hr || '0 H/s'}</div>
                    </div>
                    <div class="timeframe-card">
                        <div class="timeframe-label">Last 24 hours</div>
                        <div class="timeframe-value">${worker.hashrate1d || '0 H/s'}</div>
                    </div>
                </div>
            `;
            
            container.appendChild(minerCard);
        });
    }
    
    function updateChart(data) {
        const canvas = document.getElementById('hashrateChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        if (chartInstance) {
            chartInstance.destroy();
        }
        
        // Prepare data
        const hashrate1m = parseHashrate(data.hashrate1m);
        const hashrate5m = parseHashrate(data.hashrate5m);
        const hashrate1hr = parseHashrate(data.hashrate1hr);
        const hashrate1d = parseHashrate(data.hashrate1d);
        const hashrate7d = parseHashrate(data.hashrate7d);
        
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['1m', '5m', '1hr', '1d', '7d'],
                datasets: [{
                    label: 'Total Hashrate',
                    data: [hashrate1m, hashrate5m, hashrate1hr, hashrate1d, hashrate7d],
                    borderColor: '#58a6ff',
                    backgroundColor: 'rgba(88, 166, 255, 0.2)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3,
                    pointBackgroundColor: '#58a6ff',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // Critical for fixed height container
                plugins: {
                    legend: { 
                        labels: { 
                            color: '#8b949e', 
                            font: { size: 12 },
                            padding: 20
                        },
                        position: 'top'
                    },
                    tooltip: {
                        backgroundColor: '#161b22',
                        titleColor: '#c9d1d9',
                        bodyColor: '#58a6ff',
                        borderColor: '#30363d',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                let value = context.raw;
                                if (value >= 1000000) return (value/1000000).toFixed(2) + ' MH/s';
                                if (value >= 1000) return (value/1000).toFixed(2) + ' KH/s';
                                return value.toFixed(0) + ' H/s';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { 
                            color: '#8b949e',
                            font: { size: 11 },
                            padding: 10,
                            callback: function(value) {
                                if (value >= 1000000) return (value/1000000).toFixed(1) + 'M';
                                if (value >= 1000) return (value/1000).toFixed(1) + 'K';
                                return value;
                            }
                        },
                        grid: { 
                            color: '#30363d',
                            drawBorder: false
                        }
                    },
                    x: {
                        ticks: { 
                            color: '#8b949e', 
                            font: { size: 12 },
                            padding: 10
                        },
                        grid: { 
                            color: '#30363d',
                            drawBorder: false
                        }
                    }
                },
                elements: {
                    line: {
                        tension: 0.3
                    }
                },
                layout: {
                    padding: {
                        top: 10,
                        bottom: 10,
                        left: 10,
                        right: 10
                    }
                }
            }
        });
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        fetchData();
        // Update every 30 seconds
        setInterval(fetchData, 30000);
    });
</script>
</body>
</html>